{
  "name": "Sarah - Multi-Turn Agent Tests",
  "description": "Multi-turn conversation scenarios testing all agent types for Sarah (V2 swarm-based architecture)",
  "version": "2.0",
  "type": "multi_turn",
  "scenarios": [
    {
      "id": "sarah_greeting_expense_budget_query",
      "persona": "sarah",
      "description": "Tests: Small talk → Log expense → Budget query flow",
      "context": {
        "month": "current"
      },
      "turns": [
        {
          "turn": 1,
          "description": "Greeting (router agent responds directly)",
          "input": {
            "message": "Hi there!",
            "conversation_history": []
          },
          "expected_output": {
            "response_contains": ["hello", "help"]
          }
        },
        {
          "turn": 2,
          "description": "Log expense (log_expense agent via handoff)",
          "input": {
            "message": "I spent $100 on groceries yesterday",
            "conversation_history": [
              { "role": "user", "content": "Hi there!" },
              {
                "role": "assistant",
                "content": "Hello! How can I help you today?"
              }
            ]
          },
          "expected_output": {
            "response_contains": ["logged", "groceries", "100"],
            "state_changes": [
              {
                "field": "budget_categories.groceries.spent",
                "operation": "+",
                "value": 100.0
              }
            ]
          }
        },
        {
          "turn": 3,
          "description": "Budget query (budget_query agent via handoff)",
          "input": {
            "message": "What's my grocery budget looking like now?",
            "conversation_history": [
              { "role": "user", "content": "Hi there!" },
              {
                "role": "assistant",
                "content": "Hello! How can I help you today?"
              },
              {
                "role": "user",
                "content": "I spent $100 on groceries yesterday"
              },
              {
                "role": "assistant",
                "content": "I've logged $100 for groceries..."
              }
            ]
          },
          "expected_output": {
            "response_contains": ["groceries", "spent", "100"]
          }
        }
      ],
      "tags": ["small_talk", "expense_logging", "budget_query", "agent_chain"]
    },
    {
      "id": "sarah_purchase_decision_feedback_budget_mod",
      "persona": "sarah",
      "description": "Tests: Purchase decision → Feedback → Budget modification",
      "context": {
        "month": "current"
      },
      "turns": [
        {
          "turn": 1,
          "description": "Purchase decision (purchase_decision agent via handoff)",
          "input": {
            "message": "Should I buy this $85 dress on sale?",
            "conversation_history": []
          },
          "expected_output": {
            "response_contains": ["score", "shopping"],
            "metadata_checks": {
              "decision_id": "not_null",
              "score": "not_null"
            }
          }
        },
        {
          "turn": 2,
          "description": "Purchase feedback - didn't buy (purchase_feedback agent via handoff)",
          "input": {
            "message": "I decided not to buy it after all",
            "conversation_history": [
              {
                "role": "user",
                "content": "Should I buy this $85 dress on sale?"
              },
              {
                "role": "assistant",
                "content": "Decision Score: 4/10 (Mild No)..."
              }
            ]
          },
          "expected_output": {
            "response_contains": ["good", "decision"]
          }
        },
        {
          "turn": 3,
          "description": "Budget modification (budget_modification agent via handoff)",
          "input": {
            "message": "Can you increase my shopping budget by $50 for this month?",
            "conversation_history": [
              {
                "role": "user",
                "content": "Should I buy this $85 dress on sale?"
              },
              { "role": "assistant", "content": "Decision Score: 4/10..." },
              {
                "role": "user",
                "content": "I decided not to buy it after all"
              },
              {
                "role": "assistant",
                "content": "Good decision! Resisting impulse..."
              }
            ]
          },
          "expected_output": {
            "response_contains": ["shopping", "50", "budget"],
            "state_changes": [
              {
                "field": "budget_categories.shopping.limit",
                "operation": "+",
                "value": 50.0
              }
            ]
          }
        }
      ],
      "tags": [
        "purchase_decision",
        "feedback",
        "budget_modification",
        "agent_chain"
      ]
    },
    {
      "id": "sarah_general_question_goal_update",
      "persona": "sarah",
      "description": "Tests: General question → Goal update flow",
      "context": {
        "month": "current"
      },
      "turns": [
        {
          "turn": 1,
          "description": "General question (general_assistant agent via handoff)",
          "input": {
            "message": "How am I doing financially this month?",
            "conversation_history": []
          },
          "expected_output": {
            "response_contains": ["budget", "financial"]
          }
        },
        {
          "turn": 2,
          "description": "Goal update (goal_update agent via handoff)",
          "input": {
            "message": "I want to add $500 to my emergency fund",
            "conversation_history": [
              {
                "role": "user",
                "content": "How am I doing financially this month?"
              },
              {
                "role": "assistant",
                "content": "You're doing well with your budget..."
              }
            ]
          },
          "expected_output": {
            "response_contains": ["emergency fund", "500", "added"],
            "state_changes": [
              {
                "field": "goals.Emergency Fund.current_amount",
                "operation": "+",
                "value": 500.0
              }
            ]
          }
        }
      ],
      "tags": ["general_question", "goal_update", "agent_chain"]
    },
    {
      "id": "sarah_expense_then_purchase_decision",
      "persona": "sarah",
      "description": "Tests: Log expense → Purchase decision with updated budget context",
      "context": {
        "month": "current"
      },
      "turns": [
        {
          "turn": 1,
          "description": "Log dining expense",
          "input": {
            "message": "I spent $45 on takeout sushi last night",
            "conversation_history": []
          },
          "expected_output": {
            "response_contains": ["logged", "dining", "45"],
            "state_changes": [
              {
                "field": "budget_categories.dining.spent",
                "operation": "+",
                "value": 45.0
              }
            ]
          }
        },
        {
          "turn": 2,
          "description": "Purchase decision should reflect updated budget",
          "input": {
            "message": "Should I order another $50 of takeout tonight?",
            "conversation_history": [
              {
                "role": "user",
                "content": "I spent $45 on takeout sushi last night"
              },
              {
                "role": "assistant",
                "content": "I've logged $45 for dining..."
              }
            ]
          },
          "expected_output": {
            "response_contains": ["dining", "already", "spent"],
            "response_must_not_contain": ["$0 spent", "haven't spent"]
          }
        }
      ],
      "tags": [
        "expense_logging",
        "purchase_decision",
        "budget_awareness",
        "stateful"
      ]
    },
    {
      "id": "sarah_purchase_bought_it_feedback",
      "persona": "sarah",
      "description": "Tests: Purchase decision → 'I bought it' feedback with context",
      "context": {
        "month": "current"
      },
      "turns": [
        {
          "turn": 1,
          "description": "Purchase decision for watch",
          "input": {
            "message": "Should I buy this $450 designer watch?",
            "conversation_history": []
          },
          "expected_output": {
            "response_contains": ["score", "shopping"],
            "metadata_checks": {
              "decision_id": "not_null",
              "score": "not_null"
            }
          }
        },
        {
          "turn": 2,
          "description": "Feedback - bought it (should reference previous decision)",
          "input": {
            "message": "I bought it anyway",
            "conversation_history": [
              {
                "role": "user",
                "content": "Should I buy this $450 designer watch?"
              },
              {
                "role": "assistant",
                "content": "Decision Score: 3/10 (Strong No)..."
              }
            ]
          },
          "expected_output": {
            "response_contains": ["watch", "450"],
            "state_changes": [
              {
                "field": "budget_categories.shopping.spent",
                "operation": "+",
                "value": 450.0
              }
            ]
          }
        }
      ],
      "tags": ["purchase_decision", "feedback", "context_dependent", "stateful"]
    },
    {
      "id": "sarah_multiple_expenses_then_budget_query",
      "persona": "sarah",
      "description": "Tests: Multiple expense logs → Comprehensive budget query",
      "context": {
        "month": "current"
      },
      "turns": [
        {
          "turn": 1,
          "description": "Log groceries",
          "input": {
            "message": "I spent $120 on groceries",
            "conversation_history": []
          },
          "expected_output": {
            "response_contains": ["120", "groceries"],
            "state_changes": [
              {
                "field": "budget_categories.groceries.spent",
                "operation": "+",
                "value": 120.0
              }
            ]
          }
        },
        {
          "turn": 2,
          "description": "Log transport",
          "input": {
            "message": "Also logged $80 for gas",
            "conversation_history": [
              { "role": "user", "content": "I spent $120 on groceries" },
              { "role": "assistant", "content": "Logged $120..." }
            ]
          },
          "expected_output": {
            "response_contains": ["80", "transport"],
            "state_changes": [
              {
                "field": "budget_categories.transport.spent",
                "operation": "+",
                "value": 80.0
              }
            ]
          }
        },
        {
          "turn": 3,
          "description": "Log entertainment",
          "input": {
            "message": "And $50 on a gym membership",
            "conversation_history": [
              { "role": "user", "content": "I spent $120 on groceries" },
              { "role": "assistant", "content": "Logged $120..." },
              { "role": "user", "content": "Also logged $80 for gas" },
              { "role": "assistant", "content": "Logged $80..." }
            ]
          },
          "expected_output": {
            "response_contains": ["50", "entertainment"],
            "state_changes": [
              {
                "field": "budget_categories.entertainment.spent",
                "operation": "+",
                "value": 50.0
              }
            ]
          }
        },
        {
          "turn": 4,
          "description": "Query overall budget",
          "input": {
            "message": "How's my overall budget looking?",
            "conversation_history": [
              { "role": "user", "content": "I spent $120 on groceries" },
              { "role": "assistant", "content": "Logged..." },
              { "role": "user", "content": "Also logged $80 for gas" },
              { "role": "assistant", "content": "Logged..." },
              { "role": "user", "content": "And $50 on a gym membership" },
              { "role": "assistant", "content": "Logged..." }
            ]
          },
          "expected_output": {
            "response_contains": ["groceries", "transport", "entertainment"]
          }
        }
      ],
      "tags": ["expense_logging", "budget_query", "multi_category", "stateful"]
    },
    {
      "id": "sarah_multi_expense_single_message_new_category",
      "persona": "sarah",
      "description": "Tests: Multi-expense in one message → Missing category → Add category → Re-log expenses",
      "context": {
        "month": "current"
      },
      "turns": [
        {
          "turn": 1,
          "description": "Log multiple expenses without amounts (log_expense agent asks for clarification)",
          "input": {
            "message": "I paid rent, utilities, and my phone bill today",
            "conversation_history": []
          },
          "expected_output": {
            "response_contains": ["how much", "rent", "utilities", "phone"],
            "requires_clarification": true
          }
        },
        {
          "turn": 2,
          "description": "Provide amounts — triggers missing 'general' category",
          "input": {
            "message": "$500 on rent, $100 on utilities and a $50 on the phone bill",
            "conversation_history": [
              {
                "role": "user",
                "content": "I paid rent, utilities, and my phone bill today"
              },
              {
                "role": "assistant",
                "content": "How much did you spend on each? (rent, utilities, phone bill)"
              }
            ]
          },
          "expected_output": {
            "response_contains": ["general", "category", "add"],
            "requires_clarification": true
          }
        },
        {
          "turn": 3,
          "description": "User agrees to add new category - agent asks for limit (requires clarification)",
          "input": {
            "message": "Yes please",
            "conversation_history": [
              {
                "role": "user",
                "content": "I paid rent, utilities, and my phone bill today"
              },
              {
                "role": "assistant",
                "content": "How much did you spend on each? (rent, utilities, phone bill)"
              },
              {
                "role": "user",
                "content": "$500 on rent, $100 on utilities and a $50 on the phone bill"
              },
              {
                "role": "assistant",
                "content": "There's no 'general' category in your budget. Your current categories are: groceries, dining, shopping, entertainment, transport. Would you like me to add a 'general' category to your budget?"
              }
            ]
          },
          "expected_output": {
            "response_contains": ["limit", "how much", "budget"],
            "requires_clarification": true
          }
        },
        {
          "turn": 4,
          "description": "User provides limit - category created",
          "input": {
            "message": "$1000 per month",
            "conversation_history": [
              {
                "role": "user",
                "content": "I paid rent, utilities, and my phone bill today"
              },
              {
                "role": "assistant",
                "content": "How much did you spend on each? (rent, utilities, phone bill)"
              },
              {
                "role": "user",
                "content": "$500 on rent, $100 on utilities and a $50 on the phone bill"
              },
              {
                "role": "assistant",
                "content": "There's no 'general' category in your budget. Would you like me to add a 'general' category?"
              },
              { "role": "user", "content": "Yes please" },
              {
                "role": "assistant",
                "content": "What spending limit would you like for the 'general' category?"
              }
            ]
          },
          "expected_output": {
            "response_contains": ["added", "general", "1000"],
            "state_changes": [
              {
                "field": "budget_categories.general.limit",
                "operation": "=",
                "value": 1000.0
              },
              {
                "field": "budget_categories.general.spent",
                "operation": "=",
                "value": 0.0
              }
            ]
          }
        },
        {
          "turn": 5,
          "description": "Re-log the expenses now that category exists",
          "input": {
            "message": "$500 on rent, $100 on utilities and $50 on the phone bill",
            "conversation_history": [
              {
                "role": "user",
                "content": "I paid rent, utilities, and my phone bill today"
              },
              {
                "role": "assistant",
                "content": "How much did you spend on each? (rent, utilities, phone bill)"
              },
              {
                "role": "user",
                "content": "$500 on rent, $100 on utilities and a $50 on the phone bill"
              },
              {
                "role": "assistant",
                "content": "There's no 'general' category in your budget. Would you like me to add a 'general' category?"
              },
              { "role": "user", "content": "Yes please" },
              {
                "role": "assistant",
                "content": "What spending limit would you like for the 'general' category?"
              },
              { "role": "user", "content": "$1000 per month" },
              {
                "role": "assistant",
                "content": "I've added the 'general' category with a $1000 monthly limit."
              }
            ]
          },
          "expected_output": {
            "response_contains": ["500", "100", "50", "general"],
            "state_changes": [
              {
                "field": "budget_categories.general.spent",
                "operation": "+",
                "value": 650.0
              }
            ]
          }
        }
      ],
      "tags": [
        "multi_expense",
        "new_category",
        "budget_modification",
        "clarification",
        "stateful"
      ]
    },
    {
      "id": "sarah_ambiguous_feedback_resolution",
      "persona": "sarah",
      "description": "Tests: Purchase decision → Ambiguous feedback ('it') → Context resolution",
      "context": {
        "month": "current"
      },
      "turns": [
        {
          "turn": 1,
          "description": "Purchase decision for sneakers",
          "input": {
            "message": "Should I buy these $120 running sneakers?",
            "conversation_history": []
          },
          "expected_output": {
            "response_contains": ["score", "shopping"],
            "metadata_checks": {
              "decision_id": "not_null",
              "score": "not_null"
            }
          }
        },
        {
          "turn": 2,
          "description": "Ambiguous pronoun ('it') should resolve to sneakers decision",
          "input": {
            "message": "I didn't get it",
            "conversation_history": [
              {
                "role": "user",
                "content": "Should I buy these $120 running sneakers?"
              },
              {
                "role": "assistant",
                "content": "Decision Score: 6/10 (Probably Yes) for running sneakers..."
              }
            ]
          },
          "expected_output": {
            "response_contains": ["sneakers", "120"],
            "response_must_not_contain": ["which item", "what purchase"]
          }
        }
      ],
      "tags": [
        "purchase_feedback",
        "context_resolution",
        "pronoun_reference",
        "edge_case"
      ]
    },
    {
      "id": "sarah_overbudget_purchase_decision",
      "persona": "sarah",
      "description": "Tests: Purchase decision when already over budget",
      "context": {
        "month": "current"
      },
      "turns": [
        {
          "turn": 1,
          "description": "Log expense that pushes category over budget",
          "input": {
            "message": "I spent $450 on groceries this week",
            "conversation_history": []
          },
          "expected_output": {
            "response_contains": ["logged", "450", "groceries"],
            "state_changes": [
              {
                "field": "budget_categories.groceries.spent",
                "operation": "+",
                "value": 450.0
              }
            ]
          }
        },
        {
          "turn": 2,
          "description": "Purchase decision should warn about over-budget status",
          "input": {
            "message": "Should I buy $100 more groceries?",
            "conversation_history": [
              {
                "role": "user",
                "content": "I spent $450 on groceries this week"
              },
              {
                "role": "assistant",
                "content": "I've logged $450... You're over budget!"
              }
            ]
          },
          "expected_output": {
            "response_contains": ["over budget", "groceries", "already spent"],
            "response_must_not_contain": ["good idea", "affordable"]
          }
        }
      ],
      "tags": [
        "purchase_decision",
        "over_budget",
        "budget_awareness",
        "edge_case"
      ]
    },
    {
      "id": "sarah_goal_conflict_purchase_decision",
      "persona": "sarah",
      "description": "Tests: Purchase decision conflicts with active savings goal",
      "context": {
        "month": "current"
      },
      "turns": [
        {
          "turn": 1,
          "description": "Update goal to establish savings priority",
          "input": {
            "message": "I want to save $300 this month for my emergency fund",
            "conversation_history": []
          },
          "expected_output": {
            "response_contains": ["emergency", "300", "goal"],
            "state_changes": [
              {
                "field": "goals.Emergency Fund.current_amount",
                "operation": "+",
                "value": 300.0
              }
            ]
          }
        },
        {
          "turn": 2,
          "description": "Purchase decision should mention goal conflict",
          "input": {
            "message": "Should I buy this $200 video game console?",
            "conversation_history": [
              {
                "role": "user",
                "content": "I want to save $300 this month for my emergency fund"
              },
              {
                "role": "assistant",
                "content": "Great! I've added $300 to your emergency fund..."
              }
            ]
          },
          "expected_output": {
            "response_contains": ["emergency", "goal", "savings"],
            "response_must_not_contain": ["great purchase", "go for it"]
          }
        }
      ],
      "tags": [
        "purchase_decision",
        "goal_conflict",
        "financial_priorities",
        "edge_case"
      ]
    },
    {
      "id": "sarah_rapid_category_switching",
      "persona": "sarah",
      "description": "Tests: Rapid switching between categories with context tracking",
      "context": {
        "month": "current"
      },
      "turns": [
        {
          "turn": 1,
          "description": "Query groceries",
          "input": {
            "message": "How much have I spent on groceries?",
            "conversation_history": []
          },
          "expected_output": {
            "response_contains": ["groceries", "spent"]
          }
        },
        {
          "turn": 2,
          "description": "Switch to dining without explicit mention",
          "input": {
            "message": "What about dining out?",
            "conversation_history": [
              {
                "role": "user",
                "content": "How much have I spent on groceries?"
              },
              {
                "role": "assistant",
                "content": "You've spent $150 on groceries..."
              }
            ]
          },
          "expected_output": {
            "response_contains": ["dining", "spent"],
            "response_must_not_contain": ["groceries"]
          }
        },
        {
          "turn": 3,
          "description": "Switch to entertainment",
          "input": {
            "message": "And entertainment?",
            "conversation_history": [
              {
                "role": "user",
                "content": "How much have I spent on groceries?"
              },
              {
                "role": "assistant",
                "content": "You've spent $150 on groceries..."
              },
              {
                "role": "user",
                "content": "What about dining out?"
              },
              {
                "role": "assistant",
                "content": "You've spent $80 on dining..."
              }
            ]
          },
          "expected_output": {
            "response_contains": ["entertainment", "spent"],
            "response_must_not_contain": ["groceries", "dining"]
          }
        }
      ],
      "tags": [
        "budget_query",
        "context_switching",
        "category_tracking",
        "edge_case"
      ]
    },
    {
      "id": "sarah_regret_feedback_learning",
      "persona": "sarah",
      "description": "Tests: Regretted purchase → Similar purchase decision uses past regret",
      "context": {
        "month": "current"
      },
      "turns": [
        {
          "turn": 1,
          "description": "Purchase decision for impulse item",
          "input": {
            "message": "Should I buy this $80 decorative lamp?",
            "conversation_history": []
          },
          "expected_output": {
            "response_contains": ["score", "shopping"],
            "metadata_checks": {
              "decision_id": "not_null"
            }
          }
        },
        {
          "turn": 2,
          "description": "Feedback with high regret",
          "input": {
            "message": "I bought it but I really regret it, it doesn't match my decor",
            "conversation_history": [
              {
                "role": "user",
                "content": "Should I buy this $80 decorative lamp?"
              },
              {
                "role": "assistant",
                "content": "Decision Score: 5/10..."
              }
            ]
          },
          "expected_output": {
            "response_contains": ["sorry", "regret", "learn"],
            "state_changes": [
              {
                "field": "budget_categories.shopping.spent",
                "operation": "+",
                "value": 80.0
              }
            ]
          }
        },
        {
          "turn": 3,
          "description": "Similar purchase should reference past regret",
          "input": {
            "message": "Should I buy this $70 decorative vase?",
            "conversation_history": [
              {
                "role": "user",
                "content": "Should I buy this $80 decorative lamp?"
              },
              {
                "role": "assistant",
                "content": "Decision Score: 5/10..."
              },
              {
                "role": "user",
                "content": "I bought it but I really regret it, it doesn't match my decor"
              },
              {
                "role": "assistant",
                "content": "I'm sorry to hear that. Let's learn from this..."
              }
            ]
          },
          "expected_output": {
            "response_contains": ["lamp", "regret", "similar", "decorative"],
            "response_must_not_contain": ["great idea", "go ahead"]
          }
        }
      ],
      "tags": [
        "purchase_decision",
        "feedback",
        "regret_learning",
        "pattern_detection",
        "edge_case"
      ]
    },
    {
      "id": "sarah_zero_amount_edge_case",
      "persona": "sarah",
      "description": "Tests: Handling zero or invalid amounts in expense logging",
      "context": {
        "month": "current"
      },
      "turns": [
        {
          "turn": 1,
          "description": "Attempt to log $0 expense",
          "input": {
            "message": "I spent $0 on groceries today",
            "conversation_history": []
          },
          "expected_output": {
            "response_contains": ["amount", "0"],
            "response_must_not_contain": ["logged $0"]
          }
        },
        {
          "turn": 2,
          "description": "Log valid expense after clarification",
          "input": {
            "message": "Actually, I spent $25 on groceries",
            "conversation_history": [
              {
                "role": "user",
                "content": "I spent $0 on groceries today"
              },
              {
                "role": "assistant",
                "content": "I can't log a $0 expense. Did you mean to enter a different amount?"
              }
            ]
          },
          "expected_output": {
            "response_contains": ["logged", "25", "groceries"],
            "state_changes": [
              {
                "field": "budget_categories.groceries.spent",
                "operation": "+",
                "value": 25.0
              }
            ]
          }
        }
      ],
      "tags": ["expense_logging", "validation", "zero_amount", "edge_case"]
    },
    {
      "id": "sarah_multi_step_budget_expense_chain",
      "persona": "sarah",
      "description": "Tests: Budget modification → Immediate expense log in same category",
      "context": {
        "month": "current"
      },
      "turns": [
        {
          "turn": 1,
          "description": "Add new category with specific limit",
          "input": {
            "message": "Add a 'fitness' category with $200 limit",
            "conversation_history": []
          },
          "expected_output": {
            "response_contains": ["fitness", "200", "added"],
            "state_changes": [
              {
                "field": "budget_categories.fitness.limit",
                "operation": "=",
                "value": 200.0
              },
              {
                "field": "budget_categories.fitness.spent",
                "operation": "=",
                "value": 0.0
              }
            ]
          }
        },
        {
          "turn": 2,
          "description": "Log expense to newly created category",
          "input": {
            "message": "I just spent $45 on a yoga class",
            "conversation_history": [
              {
                "role": "user",
                "content": "Add a 'fitness' category with $200 limit"
              },
              {
                "role": "assistant",
                "content": "I've added the 'fitness' category with a $200 monthly limit."
              }
            ]
          },
          "expected_output": {
            "response_contains": ["logged", "45", "fitness"],
            "state_changes": [
              {
                "field": "budget_categories.fitness.spent",
                "operation": "+",
                "value": 45.0
              }
            ]
          }
        },
        {
          "turn": 3,
          "description": "Query the new category to verify",
          "input": {
            "message": "How much is left in my fitness budget?",
            "conversation_history": [
              {
                "role": "user",
                "content": "Add a 'fitness' category with $200 limit"
              },
              {
                "role": "assistant",
                "content": "I've added the 'fitness' category with a $200 monthly limit."
              },
              {
                "role": "user",
                "content": "I just spent $45 on a yoga class"
              },
              {
                "role": "assistant",
                "content": "I've logged $45 for fitness..."
              }
            ]
          },
          "expected_output": {
            "response_contains": ["fitness", "155", "45", "200"],
            "response_must_not_contain": ["0 spent", "$200 left"]
          }
        }
      ],
      "tags": [
        "budget_modification",
        "expense_logging",
        "budget_query",
        "multi_step_chain",
        "edge_case"
      ]
    },
    {
      "id": "sarah_multiple_goals_concurrent_update",
      "persona": "sarah",
      "description": "Tests: Updating multiple goals in sequence",
      "context": {
        "month": "current"
      },
      "turns": [
        {
          "turn": 1,
          "description": "Update emergency fund",
          "input": {
            "message": "I added $200 to my emergency fund",
            "conversation_history": []
          },
          "expected_output": {
            "response_contains": ["emergency fund", "200"],
            "state_changes": [
              {
                "field": "goals.Emergency Fund.current_amount",
                "operation": "+",
                "value": 200.0
              }
            ]
          }
        },
        {
          "turn": 2,
          "description": "Update vacation fund without mentioning previous goal",
          "input": {
            "message": "Also put $150 toward my vacation",
            "conversation_history": [
              {
                "role": "user",
                "content": "I added $200 to my emergency fund"
              },
              {
                "role": "assistant",
                "content": "Great job! You've added $200 to your emergency fund..."
              }
            ]
          },
          "expected_output": {
            "response_contains": ["vacation", "150"],
            "state_changes": [
              {
                "field": "goals.Vacation Fund.current_amount",
                "operation": "+",
                "value": 150.0
              }
            ]
          }
        },
        {
          "turn": 3,
          "description": "General question about progress",
          "input": {
            "message": "How am I doing with my savings?",
            "conversation_history": [
              {
                "role": "user",
                "content": "I added $200 to my emergency fund"
              },
              {
                "role": "assistant",
                "content": "Great job! You've added $200 to your emergency fund..."
              },
              {
                "role": "user",
                "content": "Also put $150 toward my vacation"
              },
              {
                "role": "assistant",
                "content": "Excellent! $150 added to vacation fund..."
              }
            ]
          },
          "expected_output": {
            "response_contains": ["emergency", "vacation", "200", "150"]
          }
        }
      ],
      "tags": ["goal_update", "multiple_goals", "context_tracking", "edge_case"]
    },
    {
      "id": "sarah_purchase_decision_no_budget_category",
      "persona": "sarah",
      "description": "Tests: Purchase decision for item in non-existent category → Manual category creation → Feedback logging",
      "context": {
        "month": "current"
      },
      "turns": [
        {
          "turn": 1,
          "description": "Purchase decision for item in uncategorized area",
          "input": {
            "message": "Should I buy this $300 laptop stand for work?",
            "conversation_history": []
          },
          "expected_output": {
            "response_contains": ["score"],
            "metadata_checks": {
              "decision_id": "not_null",
              "score": "not_null"
            }
          }
        },
        {
          "turn": 2,
          "description": "Create office category before logging feedback",
          "input": {
            "message": "Create an office category with $500 limit",
            "conversation_history": [
              {
                "role": "user",
                "content": "Should I buy this $300 laptop stand for work?"
              },
              {
                "role": "assistant",
                "content": "Decision Score: 7/10... Note: You don't have an 'office' category yet..."
              }
            ]
          },
          "expected_output": {
            "response_contains": ["office", "500", "added"],
            "state_changes": [
              {
                "field": "budget_categories.office.limit",
                "operation": "=",
                "value": 500.0
              },
              {
                "field": "budget_categories.office.spent",
                "operation": "=",
                "value": 0.0
              }
            ]
          }
        },
        {
          "turn": 3,
          "description": "Feedback to buy - should now work with category existing",
          "input": {
            "message": "I bought the laptop stand",
            "conversation_history": [
              {
                "role": "user",
                "content": "Should I buy this $300 laptop stand for work?"
              },
              {
                "role": "assistant",
                "content": "Decision Score: 7/10..."
              },
              {
                "role": "user",
                "content": "Create an office category with $500 limit"
              },
              {
                "role": "assistant",
                "content": "I've added the 'office' category with a $500 monthly limit."
              }
            ]
          },
          "expected_output": {
            "response_contains": ["laptop stand", "300", "office"],
            "state_changes": [
              {
                "field": "budget_categories.office.spent",
                "operation": "+",
                "value": 300.0
              }
            ]
          }
        }
      ],
      "tags": [
        "purchase_decision",
        "feedback",
        "missing_category",
        "budget_modification",
        "edge_case"
      ]
    },
    {
      "id": "sarah_conflicting_intent_single_message",
      "persona": "sarah",
      "description": "Tests: Single message with multiple intents (expense + budget query)",
      "context": {
        "month": "current"
      },
      "turns": [
        {
          "turn": 1,
          "description": "Combined expense log and budget query",
          "input": {
            "message": "I spent $80 on groceries, how much do I have left?",
            "conversation_history": []
          },
          "expected_output": {
            "response_contains": ["logged", "80", "left", "groceries"],
            "state_changes": [
              {
                "field": "budget_categories.groceries.spent",
                "operation": "+",
                "value": 80.0
              }
            ]
          }
        }
      ],
      "tags": ["multi_intent", "expense_logging", "budget_query", "edge_case"]
    },
    {
      "id": "sarah_purchase_decision_with_past_regrets",
      "persona": "sarah",
      "description": "Tests: Purchase decision agent uses past regret analysis",
      "context": {
        "month": "current"
      },
      "turns": [
        {
          "turn": 1,
          "description": "Log regretted purchase via feedback",
          "input": {
            "message": "I bought a $150 smartwatch last week and I totally regret it",
            "conversation_history": []
          },
          "expected_output": {
            "response_contains": ["sorry", "regret", "smartwatch"],
            "state_changes": [
              {
                "field": "budget_categories.shopping.spent",
                "operation": "+",
                "value": 150.0
              }
            ]
          }
        },
        {
          "turn": 2,
          "description": "Purchase decision for similar tech item",
          "input": {
            "message": "Should I buy this $180 fitness tracker?",
            "conversation_history": [
              {
                "role": "user",
                "content": "I bought a $150 smartwatch last week and I totally regret it"
              },
              {
                "role": "assistant",
                "content": "I'm sorry you regret that purchase. Let's learn from it..."
              }
            ]
          },
          "expected_output": {
            "response_contains": [
              "smartwatch",
              "regret",
              "similar",
              "shopping"
            ],
            "response_must_not_contain": ["great idea", "definitely buy"]
          }
        }
      ],
      "tags": [
        "purchase_decision",
        "regret_analysis",
        "pattern_learning",
        "edge_case"
      ]
    },
    {
      "id": "sarah_interrupted_conversation_flow",
      "persona": "sarah",
      "description": "Tests: Context preservation when user changes topic mid-flow",
      "context": {
        "month": "current"
      },
      "turns": [
        {
          "turn": 1,
          "description": "Start purchase decision",
          "input": {
            "message": "Should I buy this $200 coat?",
            "conversation_history": []
          },
          "expected_output": {
            "response_contains": ["score", "shopping"],
            "metadata_checks": {
              "decision_id": "not_null"
            }
          }
        },
        {
          "turn": 2,
          "description": "Interrupt with unrelated budget query",
          "input": {
            "message": "Wait, how much have I spent on groceries this month?",
            "conversation_history": [
              {
                "role": "user",
                "content": "Should I buy this $200 coat?"
              },
              {
                "role": "assistant",
                "content": "Decision Score: 6/10 for the coat..."
              }
            ]
          },
          "expected_output": {
            "response_contains": ["groceries", "spent"],
            "response_must_not_contain": ["coat", "200"]
          }
        },
        {
          "turn": 3,
          "description": "Return to original purchase decision",
          "input": {
            "message": "Okay, I think I'll buy the coat",
            "conversation_history": [
              {
                "role": "user",
                "content": "Should I buy this $200 coat?"
              },
              {
                "role": "assistant",
                "content": "Decision Score: 6/10 for the coat..."
              },
              {
                "role": "user",
                "content": "Wait, how much have I spent on groceries this month?"
              },
              {
                "role": "assistant",
                "content": "You've spent $120 on groceries..."
              }
            ]
          },
          "expected_output": {
            "response_contains": ["coat", "200"],
            "state_changes": [
              {
                "field": "budget_categories.shopping.spent",
                "operation": "+",
                "value": 200.0
              }
            ]
          }
        }
      ],
      "tags": ["context_switching", "feedback", "interrupted_flow", "edge_case"]
    },
    {
      "id": "sarah_negative_amount_validation",
      "persona": "sarah",
      "description": "Tests: Handling negative amounts and refunds",
      "context": {
        "month": "current"
      },
      "turns": [
        {
          "turn": 1,
          "description": "Attempt to log negative expense",
          "input": {
            "message": "I got a $30 refund on groceries",
            "conversation_history": []
          },
          "expected_output": {
            "response_contains": ["refund", "30", "groceries"],
            "state_changes": [
              {
                "field": "budget_categories.groceries.spent",
                "operation": "-",
                "value": 30.0
              }
            ]
          }
        }
      ],
      "tags": ["expense_logging", "refund", "negative_amount", "edge_case"]
    },
    {
      "id": "sarah_very_long_conversation_context",
      "persona": "sarah",
      "description": "Tests: Context retention over extended conversation (10+ turns)",
      "context": {
        "month": "current"
      },
      "turns": [
        {
          "turn": 1,
          "description": "Initial purchase decision",
          "input": {
            "message": "Should I buy a $150 blender?",
            "conversation_history": []
          },
          "expected_output": {
            "response_contains": ["score", "shopping"],
            "metadata_checks": {
              "decision_id": "not_null"
            }
          }
        },
        {
          "turn": 2,
          "description": "Log unrelated expense",
          "input": {
            "message": "I spent $60 on gas",
            "conversation_history": [
              { "role": "user", "content": "Should I buy a $150 blender?" },
              { "role": "assistant", "content": "Decision Score: 5/10..." }
            ]
          },
          "expected_output": {
            "response_contains": ["logged", "60", "transport"]
          }
        },
        {
          "turn": 3,
          "description": "Budget query",
          "input": {
            "message": "How's my entertainment budget?",
            "conversation_history": [
              { "role": "user", "content": "Should I buy a $150 blender?" },
              { "role": "assistant", "content": "Decision Score: 5/10..." },
              { "role": "user", "content": "I spent $60 on gas" },
              { "role": "assistant", "content": "Logged $60..." }
            ]
          },
          "expected_output": {
            "response_contains": ["entertainment", "spent"]
          }
        },
        {
          "turn": 4,
          "description": "Goal update",
          "input": {
            "message": "I saved $100 for vacation",
            "conversation_history": [
              { "role": "user", "content": "Should I buy a $150 blender?" },
              { "role": "assistant", "content": "Decision Score: 5/10..." },
              { "role": "user", "content": "I spent $60 on gas" },
              { "role": "assistant", "content": "Logged $60..." },
              { "role": "user", "content": "How's my entertainment budget?" },
              { "role": "assistant", "content": "Entertainment: $50/$200..." }
            ]
          },
          "expected_output": {
            "response_contains": ["vacation", "100"]
          }
        },
        {
          "turn": 5,
          "description": "Reference original decision from turn 1",
          "input": {
            "message": "About that blender, I decided to buy it",
            "conversation_history": [
              { "role": "user", "content": "Should I buy a $150 blender?" },
              { "role": "assistant", "content": "Decision Score: 5/10..." },
              { "role": "user", "content": "I spent $60 on gas" },
              { "role": "assistant", "content": "Logged $60..." },
              { "role": "user", "content": "How's my entertainment budget?" },
              { "role": "assistant", "content": "Entertainment: $50/$200..." },
              { "role": "user", "content": "I saved $100 for vacation" },
              { "role": "assistant", "content": "Great! $100 added..." }
            ]
          },
          "expected_output": {
            "response_contains": ["blender", "150"],
            "state_changes": [
              {
                "field": "budget_categories.shopping.spent",
                "operation": "+",
                "value": 150.0
              }
            ]
          }
        }
      ],
      "tags": [
        "long_conversation",
        "context_retention",
        "delayed_reference",
        "edge_case"
      ]
    }
  ]
}
